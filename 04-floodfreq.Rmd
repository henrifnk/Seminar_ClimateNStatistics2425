---
output:
  pdf_document: default
  html_document: default
---


# Flood Frequency Analysis


*Author: Hannes Grün, Robin Schüttpelz*

*Supervisor: Henri Funk*

*Suggested degree: Master*

## Abstract {.unnumbered}


## Introduction {#intro}
TODO: Add something "decoupling"... bla
	<!-- Motivation -->
<!-- Zielsetung und Forschungsfrage formulieren und deren Relevanz motivieren -->
	<!-- Short description of content and objective of the project -->
	<!-- Short explanation of statistical methods used -->
	<!-- 	( maybe something like: Pearon's correlation coefficient measueres linear correlation between continuous vars and will be used to examine xy) -->
	<!-- > Brief presentation of key findings -->
	<!-- > Overview of each section -->
<!-- - den zum Erreichen des Ziel gewählten Weg beschreiben; dh. einen Überblick über den roten Faden der Arbeit geben -->
<!-- - Ergebnisse Zusammenfassen -->
<!-- - Arbeit strukturieren (Wie im Paper) -->

<!-- -> Klären des WAS WARUM WIE WOZU -->
<!-- Konkretisieren der Fragestellung(WAS) -->
<!-- Die praktische und wissenschaftliche Relevant (WARUM) -->
<!-- Die Vorgehensweise (WIE) -->
<!-- Das Ziel der Arbeit(WOZU) -->

## Data {#data}
Hannes: Ist meine Variablenbeschreibung korrekt? 
Könntest du noch definieren, was ein baseflow und was ein streamflow ist?

@grimaldi2006 used the variables peak, volume and duration
of the most severe flood event within a year. 
These variables are derivable from yearly hydrological discharge data.
Discharge, measured in $[m^3/s]$, denotes the volume of water passed through a river within $1$ second of time. 
The discharge data we use during our analysis 
is provided by the 
Bavarian Environmental Agency's hydrological service (GKD) (@GKDwebsite) which 
is data from multiple measurement station along the Isar and the Danube. 
Based on this, the following 
gives a brief description of the data,
discusses possible flood event detection methods,
derives the variables of interest based on the flood definition and 
ends with a display of the crucial aspects of the obtained data.

Initially, the data contains discharge values in $15$ minute steps for 
$27$ stations along the Isar and Danube from different starting time points, but always up to 31.12.2024.
We removed removed $6$ measurement stations because these contained only a few observed years 
which is problematic 
because the final copula model is fit on yearly data. Thus, the number of observed years 
corresponds to the number of data points our copula model relies on.\
Of the remaining $21$ stations, $12$ stations are along the Isar and $9$ along the Danube where every station had at least $44$ years of observation. 
As seen towards the end of this section, the alpine river Isar and the low-lying Danube have contrasting 
hydrological characteristics, enabling a meaningful comparison of flood dynamics in Bavaria.
The exact spatial distribution of the considered station displayed plot \@ref(fig:bavaria). 
```{r bavaria, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/data_bavaria_plot.png")
```

Given the annual discharge data for all these stations, we require to identify the 
most severe flood event within each year which defined as the event with the largest discharge peak. 
To stabilize event detection, the following is based on daily average discharge values we 
calculated based on the $15$ minute time intervals in the original data.\
The flood detection approach proposed by @grimaldi2006 of using the straight-line method based on a fixed threshold 
was found to be highly unreliable, but so  was a quantile-based straight-line method.
Both approaches exhibit significant uncertainties in identifying flood events, 
particularly, they tend to overestimate flood duration.
Instead, we applied
the baseflow methods proposed and implemented by @wasko2021. 
This method relies on the baseflow index (BFI) which is the ratio of the baseflow volume to the volume of streamflow. 
<!-- Calculte BFI at each time step and extracts discrete flood events when the BFI falls below the specified threshold for a user-specified minimum duration. -->

TODO: Definition baseflow and streamflow

A default BFI threshold of 0.5 was used to distinguish events dominated by rapid runoff contributions typically associated with rainfall- or melt-induced flooding.

Exemplary, figure \@ref(fig:hydro) shows the hydrograph for the station in Munich in 2024. 

```{r hydro, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/data_hydrograph.png")
```

TODO: Depending on plot, describe what the F is seen here

Based on all identified flood events, the event with the largest peak discharge is selected and, finally, the 
variables of interst are determined. That is, 
flood peak is the maximum discharge value occurring within the event,
flood duration is the time span measured in days between the start and end of the event, as determined by the BFI threshold crossings.
Flood volume is the cumulative streamflow over the flood duration, representing total discharge volume in $m^3$.

TODO: Do I want to give some max values? 

Finally, we come to the most crucial aspect in our data, but show that this structure is also found in @grimaldi2006. That is, fig \@ref(fig:corplot) displays the rank correlation coefficient Kendall's $\tau$ 
between every possible combination between the $3$ variables separated by river.
In section \@ref(kendallstau) we further discuss Kendall's $\tau$, but for now, it is sufficient to consider it as measure of the strength of the dependence between two variables.

```{r corplot, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', dpi = 300, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/data_cor_plot.png")
```

The boxplots in figure \@ref(fig:corplot) 
are based on the $9$ and $12$ stations along each river, respectively, and 
depict the $\tau$ values for the corresponding variable combination seen on the $x$-Axis.
The black dots refer to the $\tau$ values observed by @grimaldi2006. 
Most important here is that none of the boxplots align horizontally. That is, the dependence strength 
between all variable pairs differ to the others. 
Thereby, our data suggests $3$ different distinct dependencies.
This finding is most crucial and, as we will see later on, renders @grimaldi2006 approach infeasible. Because, as seen from the black dots, not only our data suggest $3$ separate dependence structures, but also the river @grimaldi2006 considered.\
Also interesting is the difference between the rivers in what variables have the strongest dependence. 
According to the figure, volume and duration are highly correlated with only little variation seen from the 
width of the boxplot. For the Isar, on the other hand, we observe not only more variation in the correlation
values, but here the most correlated pair tends to be volume and peak. 
This emphazises the aforementioned contrasting 
hydrological characteristics which are highly relevant for copula modelling and, thereby, for our analysis.
<!-- Mention: Isar has similar correlation structure as in paper -->

## Methods {#methods}
To address the dependence structures identified in the previous section, 
this chapter 
extends the approach of @grimaldi2006 by incorporating vine copulas. 
This extension is necessary because a simpler approach is insufficient to capture the full correlation pattern
observed in the data. 
The following introduces the foundational theory of copulas, 
the family of Archimedean copulas as well as nested Archimedean and vine copula models. 
In addition, methods for copula fitting and model selection are briefly discussed. 
Then, some applied, but non-essential methods are briefly established. 
Together, these elements form the theoretical framework on which this paper is based.
Finally, a few words to the implementation of these methods and used packages.
	
### Copulas {#cops}

@zhang2019 (p. 62) describe a copula as a cumulative distribution
function (CDF) with standard uniform margins. The dimension $d$ of a copula
denotes the number of random variables it relates and, hence, a copula is at least bivariate ($d \geq 2$).
To give a mathematical definition, consider the vector
$u = (u_1, ..., u_d) \in \mathbb{R}^d$ where $u_j \in [0, 1]$ for
$j = 1, .., d$. Then, a $d$ dimensional copula is defined by
@durante2016 (p. 14) as function $C:[0,1]^d\to [0,1]$ if, and only if,
the following conditions hold:

i)  $C(u_1, ..., u_d) = 0$ if $u_j = 0$ for at least one
    $j \in \{1,…,d\}$.

ii) $C(1, 1, ..., 1, u_j, 1, ..., 1) = u_j$

iii) $C$ is $d$-increasing

<!-- The first two conditions make up the boundary conditions of a $d$ -->
<!-- copula. This notion is due to the fact the conditions use the least and -->
<!-- the greatest element in the domain of the copula, respectively (see -->
<!-- @nelsen2006, p. 9). -->

According to @nelsen2006 (p. 9), condition i. shows that copulas 
are grounded. In this context, grounded means that
plugging in $0$ for just one of the variables yields a copula value of $0$, independent of the 
other variables' value.
The author also mentions that, using condition ii., the margins of the function $C$ with respect to a certain variables are obtained by 
plugging in $1$ for all other variables. 
Finally, the condition of $C$ to be $d$-increasing is cumbersome to map out in
higher dimensions, which is why the following is restricted to the $d = 2$ case.
According to @nelsen2006 (p. 8), the copula function $C$ is
$2$-increasing if for all $u_1, u_2, v_1, v_2 \in [0,1]$ with
$u_1 \leq u_2$ and $v_1 \leq v_2$: 
$$
C(u_2, v_2) - C(u_2, v_1) - C(u_1, v_2) + C(u_1, v_1) \geq 0
(\#eq:twoincreasing)
$$ Simply put, 2-increasing means that the volume under the copula density
function over the rectangle $[u_1, u_2] \times [v_1, v_2]$ is
non-negative. This interpretation follows from the fact that copula functions are defined as CDF and holds for higher dimensions, too.\
<!-- Based on condition i. and iii., @nelsen2006 (p. 9) also concludes that to  -->
<!-- the copula function $C$ is nondecreasing in -->
<!-- each argument. \ -->
The next section introduces the central theorem in copula theory and also derives the already mentioned copula density. 

### Sklar's Theorem {#sklarstheorem}
Sklar's Theorem is central to the theory of copulas as it proves
that any multivariate distribution can be constructed using copulas
(@nelsen2006 p. 17, @durante2016 p. 42). Thereby, this theorem allows
to separate the representation of the dependence structure and marginal
distribution functions. The theorem is given by @nelsen2006 (p. 18):\
Let $F_{1,..,d}$ be a $d$-dimensional joint distribution function with
univariate margins $F_1, ..., F_d$. Then, there exists a $d$-dimensional
copula $C$ such that $$
F_{1, ..., d}(x_1, ..., x_d)  = C(F_1(x_1), ..., F_d(x_d)) = C(u_1, ..., u_d)
(\#eq:sklar)
$$ where $u_i = F_i(x_i)$. Also, $C$ is unique if $F_1, ..., F_d$ are continuous. 
Equation \@ref(eq:sklar) allows $2$ important conclusion: One,
any multivariate CDF may be expressed as a composition of a copula
function $C$ and the univariate margins $F_1, ..., F_d$. Thereby,
@zhang2019 (p. 66) conclude that $C$ connects the multivariate CDF to
its margins which allows to separately consider marginal and 
joint behavior of variables. That is, the problem of determining any
multivariate CDF is reduced to determining the copula. And two, the
marginal distributions do not need to be of the same family because
Sklar's theorem holds regardless.

The aforementioned copula density function is given by (see
@zhang2019, p. 66): $$
c(u_1, ..., u_d) = \frac{\partial C(u_1, ..., u_d)}{\partial u_1 ... \partial u_d} = \frac{f(x_1, ..., x_d)}{\Pi_{i = 1}^df_i(x_i)}
(\#eq:copulapdf)
$$ where $f(x_1, ..., x_d)$ denotes the joint density of $X_1, ..., X_d$
and $f_i(x_i)$ the marginal density of $X_i$ for 
$i = 1, ..., d$. Based on this equation, the joint density in terms of the copula density is given by 
$$
f(x_1, ..., x_d) = c(u_1, ..., u_d)\Pi_{i = 1}^df_i(x_i)
(\#eq:marginalpdf)
$$

### Symmetric Archimedean copulas and generator functions {#archcops}
As Nelsen (p. 109) states, symmetric Archimedean copulas (SACs) are
widely applied due to their large variety and easy construction. However, SACs only allow the same 
dependence strength and structure among all possible pairs of variables as @zhang2019
(p.124) point out. Therefore, they are not suitable for our analysis as concluded from figure \@ref(fig:corplot) which suggested $3$ distinct correlation values.
However, SACs remain an important building block for more complex copula models. 
Thus, this section introduces the concept of a generator function as it determines the family a SACs belongs to.
Then, we specifically focus on bivariate SACs because following models are based on these.

We first give the general idea of a generator, then the
representation of a copula in terms of the generator and in the end the
copula families we use for our analysis.\
@nelsen2006 (p. 110, 111) defines a generator to be a
continuous and strictly decreasing function
$\phi: [0, 1] \to [0, \infty)$ such that $\phi(1) = 0$. 
If $\phi(0) \to \infty$, the generator is considered to be strict.
The inverse $\phi^{-1}:[0, \infty) \to [0, 1]$  of such generators is 
strictly decreasing on $[0, \phi(0)]$. 
We only apply strict generators as seen towards the end of this section.\
For a generator to yield a valid $d$-dimensional copula,
@grimaldi2006 and @zhang2019 (p. 124) mention that the inverse
requires to be completely monotone which is given if it has
derivatives of all orders with alternating sign $$
(-1)^k \frac{d^k \phi^{-1}(t|\theta)}{dt^k} \geq 0.
(\#eq:changingsign)
$$
Now, we are in the position to formulate the general representation of a
$d$-dimensional SAC in terms of its generator. 
The relation is given by
@zhang2019 (p. 123) as$$
C(u_1, u_2, u_3 \mid \theta) = \phi^{-1} \left( \phi(u_1 \mid \theta) + \phi(u_2 \mid \theta) + \phi(u_3 \mid \theta) \,\middle|\, \theta \right).
(\#eq:generatorSAC)
$$  
Equation \@ref(eq:generatorSAC) shows that
SACs are uniquely defined by their generator
function and a parameter vector $\theta$ which we introduce next.
As mentioned by @nelsen2006 (p. 110, 111, 114), the 
assumed functional form of the generator translates to a specific copula
family. Or, vice versa, assuming a copula family implies assuming a specific generator function. 
The $\theta$ vector, on the other hand, 
influences the dependence strength within the assumed copula family 
as seen in @zhang2019 (p. 86). 
This parameter vector takes on an important role in fitting a copula to observed data. 
That is, for an assumed copula family, this parameter vector remains to be estimated from the data. 
The exact approach is further discussed in section \@ref(est).
For now, note that we focus on the $3$ generator functions with a one-dimensional $\theta$ vector. 
These are specified in table \@ref(tab:generators).\
Finally, equation \@ref(eq:generatorSAC) shows that the arguments
to the SAC are exchangeable (see @nelsen2006 (p. 38)). 
Exchangeability is a form of symmetry and implies that the copula treats
all its arguments the same. 
Thereby, this representation displays the aforementioned restriction of SACs being able to only depict one unique dependence structure. 

| Copula Family | Parameter \( \theta\)           | Generator Function \( \phi(t) \) | Tail Dep.|
|:--------------|:----------------|:------------------|:---------|
| Clayton       | \( \theta \in [-1, \infty)\setminus\{0\} \)       | \( \phi(t|\theta) = \frac{1}{\theta}(t^{-\theta} - 1) \) | Lower |
| Gumbel-Hougaard        | \( \theta \in [1, \infty) \)    | \( \phi(t|\theta) = (-\ln t)^\theta \) | Upper |
| Frank         | \( \theta \in (-\infty, \infty)\setminus\{0\} \)    | \( \phi(t|\theta) = -\ln \left( \frac{e^{-\theta t} - 1}{e^{-\theta} - 1} \right) \) | None |

Table: (\#tab:generators) Generator functions of selected Archimedean copulas according to @zhang2019 (p. 130) and tail dependencies according to @zhang2019 (p. 132).

### Taildependence and Rotation
After explaining what it means for a copula to be of a certain family, 
the following introduces the family specific concept of tail dependence. 
Also, we briefly explain how copulas are manipulated to extend the dependence possible structure one family 
captures.

Tail dependence is differentiated into upper and lower tail dependence. 
Their formulas are given by @czado2019 (p. 34 - 35) as 
$$
\lambda^{\text{upper}} = \lim_{t \to 1^{-}} \mathbb{P}\left( X_2 > F_2^{-1}(t) \,\middle|\, X_1 > F_1^{-1}(t) \right) = \lim_{t \to 1^{-}} \frac{1 - 2t + C(t, t|\theta)}{1 - t}
\(#eq:uppertaildep)
$$
and 
$$
\lambda^{\text{lower}} = \lim_{t \to 0^{+}} \mathbb{P}\left( X_2 \leq F_2^{-1}(t) \,\middle|\, X_1 \leq F_1^{-1}(t) \right) 
= \lim_{t \to 0^{+}} \frac{C(t, t|\theta)}{t}.
\(#eq:lowertaildep)
$$
As seen from both equations, tail dependence is defined as conditional probability that both variables are above 
or below a threshold quantile.
<!-- a probabilistic statement in its limits. -->
Thereby, tail dependence 
measures how likely it is for both random variables to jointly exhibit extreme behavior. 
However, upper tail dependence refers to both variables attaining large values while lower tail dependence means 
both variables are jointly small. 
Note that both, upper and lower tail dependence, depend on the copula function $C$ and, thus, on the copula 
family. The tail dependencies implied by the copula families we consider are also listed in 
table \@ref(tab:generators) as stated in @zhang2019 (p. 132).\
Finally, tail dependence is a family specific property, however, a copula function may be rotated to 
change its native tail dependence behavior. 
Following @pan2024, this is done by modelling $u_i' = 1 - u_i$ instead of $u_i$ itself. 
Every such transformation concludes in a $90$ degree rotation of the copula function in the corresponding 
direction. This approach is based on the definition of the copula function as multivariate CDF.
Because if instead of $u_i$ the transformation $u_i'$ is modelled, 
the probabilistic statement of the copula in the continuous case changes to 
$C(u_1', u_2|\theta) =  \mathbb{P}(X_1 \geq x_1,X_2 \leq x_2)$ and 
$C(u_1, u_2'|\theta) =  \mathbb{P}(X_1 \leq x_1,X_2 \geq x_2)$
, respectively. 

### Fully Nested Archimedean copulas {#nacs}
Fully nested Archimedean copulas (FNACs) build upon SACs
and partially alleviate their restrictions. 
Note that these are the models @grimaldi2006 made extensive use of.\
As our analysis applies to the trivariate case, FNACs and vines in section \@ref(vines) are introduced
for this trivariate case only.

FNACs are built by nesting bivariate SACs 
$$
C(u_1, u_2, u_3 \mid \theta) = C_1\left( C_2(u_1, u_2 \mid \theta_2), u_3 \mid \theta_1 \right),
(\#eq:defFNAC) 
$$
where $\theta_1$ and $\theta_2$ are the parameters corresponding to copula function $C_1$ and $C_2$ and 
$\theta = (\theta_1, \theta_{2})$ is a vector containing all parameters. 
Note that there are only $2$ distinct parameters $\theta_i$ which is why FNACs, in the trivariate
case, are only able to capture $2$ distinct dependence structures.
This allows $2$ conclusions. First, partial exchangeability remains which means that 
within the bivariate nested copulas $C_2$, the two arguments $u_1, u_2$ are
interchangeable (see @embrecht2003 p. 375). So to a degree, symmetry
prevails.
And second, the nested variables $u_1, u_2$ have the same marginal relation with $u_3$.
That is, $C(a, 1, u_3|\theta) = C(1, a, u_3 | \theta) = C_1(a, u_3|\theta_1)$.
In essence, the statements are equivalent but the important take away is that FNACs are not 
able to display $3$ distinct dependence structures. Thereby, they are not suitable for analysis.
As also @grimaldi2006 observed $3$ distinct correlations, their results are questionable for the same reason.\
Additionally to this restriction, @hofert2016 mention that FNACs 
require the sufficient nesting condition to be fulfilled for equation \@ref(eq:defFNAC) to yield a valid copula.
We limit our considerations to FNACs where all nested copulas are of the same family. 
This corresponds to what @grimaldi2006 used in their analysis. 
Then, the sufficient nesting condition is fulfilled if 
deeper nested variables have a stronger degree of dependence, i.e. $\theta_1 \leq \theta_{2}$.
(see @grimaldi2006). 
<!-- As mentioned by @embrecht2003 (p. 375), the number of distinct -->
<!-- generators or bivariate copulas, respectively, is only $d-1$ while the -->
<!-- number of all possible pairs for $d$ variables is $\frac{d(d-1)}{2}$. -->
<!-- That is, FNACs only model $d-1$ distinct dependence structures.  -->
<!-- This -->
<!-- implies that FNACs do not consider the dependence structure for every -->
<!-- possible pair of the $d$ variables, but between a variable and a joint -->
<!-- distribution (SOURCE FOR THIS? I know I read this somewhere, but it is -->
<!-- also visible from the formula...). In fact, only for $u_1$ and $u_2$ the -->
<!-- direct dependence structure is considered.\ -->
<!-- Thereby, exchangeability is lost, but partial exchangeability remains -->
<!-- because within the bivariate nested copulas, the two arguments are -->
<!-- interchangeable (see @embrecht2003 p. 375). So to a degree, symmetry -->
<!-- prefails.\ -->
<!-- Finally, equation ref:gFNAC simplifies to ref:generatorsSAC for -->
<!-- $\phi_1 = ... = \phi_{d-1}$ and $\theta_1 = ... = \theta_{d-1}$, as -->
<!-- mentioned by @zhang2019 (p. 175). Thus, SACs are a special case of -->
<!-- FNACs. -->

<!-- Since we focus on trivariate copulas, we also formulate the FNAC -->
<!-- representation for $d = 3$ in terms of $C$: $$ -->
<!-- C(u_1, u_2, u_3) = C_1(u_3, C_2(u_1, u_2)) -->
<!-- $$ -->

<!-- -   @grimaldi2004 notes that we have identical margins for $u_3$ and -->
<!--     $u_1$ bzw. $u_2$ with $\phi_1^{[-1]}(\phi_1(u_3) + \phi(u_j))$. As -->
<!--     mentioned above, this is due to the partial exchangeability. -->

Note that equation \@ref(eq:defFNAC) may also be represented in terms of the generator function. Thereby, additional requirements 
regarding the composition of generator functions emerge, as mentioned by @zhang2019 (p. 174). 
However, discussing these requirements is beyond the purpose of this paper. The interested reader is refered to @zhang2019 (p. 174).

<!-- @zhang2019 (p. 174) give -->
<!-- the $d$-dimensional representation in terms of the generator  -->
<!-- $$ -->
<!-- \phi^{[-1]}_1 \left(  \phi_1 \circ \phi_2^{[-1]} \left( \phi_2 \circ ... \circ \phi^{[-1]}_{d-1}\left(\phi_{d-1}(u_1) + \phi_{d-1}(u_2)\right) + \phi_2(u_{d-1})  \right) + \phi_1(u_d) \right)\\ -->
<!-- (#eq:defgFNAC)  -->
<!-- $$ -->
<!-- where $\circ$ represents the composition of functions. -->
<!-- @zhang2019 (p. 174) mentions that due to the nesting of generators, $2$ -->
<!-- additional condition arise. First, $\phi_1^{-1}, ..., \phi^{-1}_{d-1}$ -->
<!-- are required to be completely monotonic and, second, the composition of -->
<!-- functions $\omega_j = \phi_j \circ \phi_{j+1}$ belongs to the function -->
<!-- class $\mathit{L}^*_\infty$ defined as $$ -->
<!-- \mathit{L}^*_\infty = \left\{ \omega:[0, \infty)\to [0, \infty)\ |\ \omega(0) = 0,\ \omega(\infty) = \infty,\ (-1)^{k-1}\frac{d^k\omega(t)}{dt^k} \geq 0; k = 1,...,\infty   \right\} -->
<!-- $$  -->


<!-- Equation ref:eq:gFNAC shows that FNACs allow different generator -->
<!-- functions $\phi_1,  ..., \phi_{d-1}$ where each has its own parameter -->
<!-- $\theta_1, ..., \theta_{d-1}$. In other words, every nested copula $j$ -->
<!-- is able to have its own varying dependence structure via $\phi_j$ and -->
<!-- varying strength of dependence via $\theta_j$ which equation -->
<!-- ref:eq:cFNAC displays.\ -->

### Vine Copulas {#vines}
Vine copulas use the pair-copula construction (PCC) explained by @czado2019 (p. 77 - 80) to characterize 
multivariate dependence structures. 
That is, PCC decomposes multivariate densities into products of (conditional) bivariate densities (see @czado2019 p. 88).  
There exist multiple vine copula classes, depending on the structure the PCC implies, but as we are concerned with the trivariate case, 
these constructions are equivalent. 

We use @czado2019 (p. 78, 90) and devine the trivariate copula density as 
$$
c_{123}(u_1, u_2, u_3|\theta) = c_{12}(u_1, u_2|\theta_{12}) \cdot  c_{23}(u_2, u_3|\theta_{23})  \cdot c_{13|2}(u_1|u_2, u_3|u_2\mid \theta_{13|2})
(\#eq:simpvinecopdf)
$$
where $u_i|u_j = F_{i|j}(x_i|x_j)$ denotes the conditional probability.
Note that this copula density is based on the simplifying assumption for vines (@czado2019 p.90, @nagler2018) which means 
that the conditional bivariate density $c_{13|2}$ is independent of exact $x_2$ values. 
It only depends on the conditional probabilities.\
Visible from the number of parameters in the $\theta$-vector, vines are able to capture all $3$ distinct
dependence structures in the trivariate case. 
Also, in contrast to FNACs from section \@ref(nacs) where we followed @grimaldi2006, we do not require the bivariate copulas to be of the same family. Thereby, 
not only the strength of dependence between all $3$ variables may differ, also 
the dependence structure is allowed to change from pair to pair. 



### Estimation and Selection Process {#est}
In practice, we need not only to estimate the parameter vector $\theta$, but also select the best fitting copula.
Thus, the following briefly introduces the pseudo maximum likelihood (ML) approach.
Also, we give a reminder on the Akaike Information Criterion (AIC) as it is our information criterion of choice to select a copula model.

To avoid assumptions on the marginal distributions, 
we estimate the parameter vector $\theta$ using the pseudo-likelihood proposed by @genest1995 
$$
\hat{\theta} = argmax_\theta\ l(\theta) = argmax_\theta\ \sum_{k = 1}^{n}log[c(u_{1k}, u_{2k}, u_{3k}|\theta)],
(\#eq:pseudologlik)
$$
where $u_{ik}$ denotes the marginal empirical distribution function scaled by $\frac{n}{n+1}$.
And depending on the copula model, the definition of the copula density follows either from 
equation \@ref(eq:defFNAC) or \@ref(eq:simpvinecopdf).
Thus, the exact estimation process slightly differs between copula models. \
The AIC is given by @fahrmeir2013 (p. 164) as 
$$
AIC = -2 l(\hat{\theta}) + 2 (|M| + 1)
(\#eq:AIC)
$$
where $l(\hat{\theta})$ represents the log-likelihood of the copula model fit and $|M|$ the number of parameters included in the model. 
We select that copula model with the smallest AIC. 

<!-- ### Empirical Copula {#EmpC} -->

<!-- ADD SOURCES FOR MY STATEMENTS -->

<!-- The probability integral transform (pit) is a transformation that allows -->
<!-- to map any random variable $X$ into standard uniform space $U(0, 1)$. -->

<!-- It is a general theorem not specific to copulas as mentioned in -->
<!-- @durante2016 (p. 6), but it helps to understand Sklar's theorem. -->

<!-- The theorem is given by @hofert (p. 3): Let $F$ be a continuous CDF and -->
<!-- let random variable $X$ have CDF $F$, that is $X \sim F$. Then $F(X)$ is -->
<!-- a standard uniform random variable, that is, $F(X) \sim U(0, 1)$. -->

<!-- TODO: Empirical PIT Empirical PIT is based on the empirical distribution -->
<!-- function\ -->
<!-- introduce pseudo-obs -->

<!-- Thus, pit provides the mechanism to transform the marginals into standard uniform variables, which is required by Sklar's Theorem.  -->

<!-- Pit is more of a prerequisit  -->

<!-- The copula utilizes these transformed variables to describe the dependence structure independent of the original marginals.  -->

### Identifying univariate margins {#gev}
While the the estimation process described in section \@ref(est) utilizes the 
empirical distribution function, an empirical function has undesired properties when re-transforming copula data.
That is, during the estimation process, the empirical distribution functions ensures we 
do not affect the copula model fit by missspecifying the marginal distributions. 
However, after fitting the copula, whenever the inverse of the empirical distribution is applied, it bins any continuous data because it is a step-wise function. This, of course, limits the power of our copula analysis. 
Thus, we decided to fit a Generalized Extreme Values (GEV) distribution to the marginal distribution only for re-transforming any results from the fitted copula models.

The distribution function for the GEV family is given by @coles2001 (p. 47)
$$
G(z) = \exp\left\{ -\left[ 1 + \xi \left( \frac{z - \mu}{\sigma} \right) \right]^{-1/\xi} \right\},
$$
defined for $\left\{ z \middle| 1 + \xi \left(\frac{z - \mu}{\sigma}\right) > 0 \right\}$ where 
$-\infty < \mu < \infty$ denotes the location parameter,
$\sigma > 0$ the scale parameter and 
$-\infty < \xi < \infty$ the shape parameter. 
In practice, these parameters are usually unknown, but @coles2001 (p. 50) describes how these parameters are estimated from data using the ML approach.\
Since GEV distributions are not at essence for our work, we refer the interested reader to @coles2001 (chapter 3)
for a more detailled consideration.

### Kendall's $\tau$ {#kendallstau}
According to @kendall1990 (p. 6), $\tau$ is a measure of association
between two random variables that distinguishes concordant and
discordant pairs. Concordance means that the two variables move in the same
direction while discordance means moving in opposite directions.\
@zhang2019 (p. 86) and @nelsen2006 (p. 159,
161 - 164) show that Kendall's $\tau$ is directly connected to the generator function and, thus,
a function in the parameter $\theta$.
$$
\tau(t)= 4 \int_0^1 \frac{\phi(t|\theta)}{\phi'(t|\theta)}dt + 1
(\#eq:cKendall)
$$ 
where $\phi'(t|\theta)$ denotes the derivative of the generator function. Note that this relation is positive
which is seen in @zhand2019 (p. 134). That is, if the parameter of copula increases, the strength of dependence
increases. Vice versa, if correlation increases, $\theta$ increases, too. Also, note that this implies that 
estimating a $\theta$ implicitly estimates a $\tau$ value.
This is a relation we will use during our simulation.
<!-- As we can see from equation @ref(eq:cKendall), Kendall's $\tau$ - a -->
<!-- measure of association - can be expressed in terms of the copula -->
<!-- function only. It emphasizes once more that the copula captures the -->
<!-- whole dependence structure between variables independent of any marginal -->
<!-- distribution functions. An alternative representation of $\tau$ is in -->
<!-- terms of the generator. We will mostly use this relation to estimate -->
<!-- Kendall's $\tau$ under (wrongfully) assumed symmetry. -->

Empirically, there are multiple versions of Kendall's $\tau$ depending
on the data structure. Since this paper focuses on continuous variables
only, the formula given by @kendall1990 (p. 5) is applicable
$$
t = \frac{P-Q}{\frac{1}{2}n(n-1)}.
(\#eq:eKendall)
$$
$P$ denotes the number of concordant and $Q$ the number of
discordant pairs in the data.

### Software {#software}
The whole analysis is implemented using the programming language R. 
We used the `hydroEvents` package by @wasko2025 
`eventBaseflow`. This method relies on the BFI as explained in the data section using a deftault BFI of $0.5$. , 
Additionally, `eventBaseflow` function calculates the BFI at each time step and extracts discrete flood events when the BFI falls below the specified threshold for a user-specified minimum duration.
For copulas, we relied on the `copula` package by 
@hofert2025 and the `pobs` function to apply the empirical distribution function as described in section \@ref(est). 
FNACs are dealt with using the 
`HAC` by @okhrin2014, especially the 
function.
`estimate.copula` for FNAC fitting which implements the ML approach from section \@ref(est). This required 
some additional code to select the best fitting copula according to the AIC.
For vine copulas, 
`VineCopula` package by @nagler2024 was consulted. 
Especially the function
`RVineCopSelect` which implicitly fits a selection of copulas and also selects the one with the smallest AIC.
Finally, GEV distribution were fitted using the function
`fevd` from the 
`extRemes` package by @gilleland2016 which uses MLE to determine the parameters mentioned in \@ref(gev).

## Simulation {#sim}
To examine how the fact that FNACs are not able to capture $3$ distinct dependence structures in a trivariate
setting affects the model results, we ran a simulation. 
We limit this section to the most crucial finding 
which is highly relevant for the interpretation of our results in the following section.

We set up the simulation by drawing $27000$ times a random samples of size $15, 30, 50, 1000$. 
The sample size of $50$ is closest to our actual setting while $1000$ observations aim to examine large sample behavior. The two smaller samples sizes are interesting because we decided to remove stations due to their small
sample size.
Additionally, for every drawn sample, 
the underlying vine copula model had $2$ wheels to tweak:
First, each copula density 
of the underlying vine copula density is allowed to be of one of the copula families 
listed in table \@ref(tab:generators) leading to a possible total of $3^3 = 27$ copula family combinations. 
And second, we allowed for $4$ different correlation values, $2$ of which correspond to the observed average 
correlation values in the Isar and the Danube. The remaining $2$ aimed to examine general behavior of FNACs 
if the true underlying model is a vine model with $3$ distinct strength of dependence. That is, 
we added a Low-Medium-High correlation structure with correlation values of $0.1, 0.5, 0.85$ and a 
Low-High-High correlation structure with values of $0.1, 0.8, 0.8$.\
Thereby, we had $27000$ data points per sample size which were divided by all $27$ possible copula family combinations
and $4$ possible correlation structures leading to roughly $\frac{27000}{4\cdot 27} = 250$ data points per setup.
It is not exactly $250$ per setup because we used a uniform draw to select copula families and correlation 
structure as simplified coding a lot. 

The result we want to highlight is displayed in figure \@ref(simresults).
```{r simresults, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/sim_NAC_if_Vine_DPG.png")
```
This figure uses multiple subplots to display the trace plots of the $\tau$ values implictly estimated by the FNAC model 
as mentioned in section \@ref(kendallstau). That is, Kendall's $\tau$ is displayed on the y-axis while the index 
of the iteration in which this model was fitted is on x-axis. Note that this plot does not differ by 
copula family combination leading to roughly $\frac{27000}{4} = 6750$ iterations each.
The black lines in each subplot refers to the true underlying correlation values.
The name of the corresponding 
correlation structure is to the right hand side of the plot.
Additionally, the figure is also divided by the sample size on which the estimated FNAC model is based. From a 
sample size of $15$ on the left up to a size of $1000$ on the right. Color-wise, the red line refers to the $\tau$ of the inner copula and the blue line to the outer copula.
Due to the mentioned sufficient nesting condition in section \@ref(nacs), the inner $\tau$ in each iteration  
must always be larger than the outer.\
The first observation is the decrease in noise as the sample size increases from left to right for 
every possible correlation structure. For now, focus only on the column of sample size $1000$. In every subplot,
the noise
in the red line is drastically reduced and we see that it mainly moved around the most upper black line. 
This is nicely seen in one of the river correlation structures. 
Thereby, the inner $\tau$ of FNACs seems to correctly estimate the larges correlation value.
However, when considering the blue line, it always moves around the second largest black line. 
Thereby, FNACs smallest $\tau$ attains the second largest correlation value in the (simulated) data.
This implies that due to the same copula margins mentioned in section \@ref(nacs) that FNACs systematically
overestimate the weakest dependence strength.\
This is an important result because it explains not only the compareably bad performance of FNACs during our 
application, but also their bias in the results.


## Application {#app}
<!-- > DETAILED description of the results, presented with help of TABLES and ILLUSTRATIONS -->
Copy structure of presentation
Mention that I only use empirical PIT for fitting and only for prediction use GEV

```{r visualGoF, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/app_visualGOF.png")
```

```{r bavariaTaildep, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/app_bavaria_taildep.png")
```

```{r probUni, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/app_univariate_hq.png")
```

```{r probMulti, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/app_multivariate_hq.png")
```

```{r modelEval, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', dpi = 52, fig.cap="Caption"}
knitr::include_graphics("./work/04-floodfreq/figures/app_modeleval.png")
```


## Discussion {#discussion}
<!-- 	> Brief recap of the objevtive of the project -->
<!-- > Interpretation of the results with reference to initial objective  -->
<!-- 	> Brief presentation of the most important results -->
<!-- 	> Discusstion of the results (possible conclusions / warnings against misinterpretation) -->
<!-- 	> Outlook (open questinos / reference to possible further analysis or research -> put into research context) -->
<!-- !!!!! Introduction and Summary should be independently readable !!!!!!! -->